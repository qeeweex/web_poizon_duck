{% extends "base.html" %}

{% block title %}Калькулятор цен Poizon{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <h1 class="hero-title">
            <i class="fas fa-calculator me-3"></i>Калькулятор PoizonDuck
        </h1>
        <p class="hero-subtitle">
            Рассчитайте итоговую стоимость товара
        </p>
    </div>
</div>

<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-transparent border-0 pt-4">
                    <h4 class="text-center mb-0">
                        <i class="fas fa-link me-2"></i>Вставьте ссылку на товар
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form id="priceForm">
                        <div class="mb-3">
                            <label for="poizonUrl" class="form-label">Ссылка на товар:</label>
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-link"></i>
                                </span>
                                <input type="text" class="form-control" id="poizonUrl" 
                                       placeholder="Вставьте текст с ссылкой на товар" required>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Поддерживаются ссылки с poizon.com, dewu.com, du.com, dw4.co и другие сокращенные ссылки
                            </div>
                        </div>
                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-calculator me-2"></i>Рассчитать цену
                            </button>
                        </div>
                    </form>
                    
                    <!-- Индикатор загрузки -->
                    <div class="loading text-center mt-4">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Загрузка...</span>
                        </div>
                        <p class="mt-2">Получаем данные о товаре это может занять 10-40 секунд...</p>
                    </div>
                    
                    <!-- Результат -->
                    <div id="result" class="mt-4" style="display: none;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="telegramModal" tabindex="-1" aria-labelledby="telegramModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="telegramModalLabel">Введите ваш Telegram</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                    <input type="text" id="telegramInput" class="form-control" placeholder="@username" autocomplete="off">
                </div>
                <div class="modal-footer">
                    <button type="button" id="confirmTelegram" class="btn btn-primary">Оформить заказ</button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('priceForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const url = document.getElementById('poizonUrl').value.trim();
    const loadingDiv = document.querySelector('.loading');
    const resultDiv = document.getElementById('result');
    const submitBtn = document.querySelector('button[type="submit"]');

    // Показываем загрузку
    loadingDiv.style.display = 'block';
    resultDiv.style.display = 'none';
    submitBtn.disabled = true;

    try {
        const response = await fetch('/calculate_price', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ url: url })
        });

        const data = await response.json();

        if (data.success) {
            // Шаг 1: показываем имя, фото и ввод цены в юанях
            resultDiv.innerHTML = `
            <div class="product-info text-center">
                    <img src="${data.image_url}" alt="${data.product_name}" class="img-fluid d-block mx-auto rounded mb-3" style="max-height:200px;"
                        onerror="this.src='https://via.placeholder.com/300x300?text=Изображение+не+найдено';">
                    <h4>${data.product_name}</h4>
                    <div class="mb-3 mt-3">
                        <label for="priceCnyInput" class="form-label">Введите цену товара в юанях (CNY):</label>
                        <input type="number" id="priceCnyInput" class="form-control" placeholder="Например 100">
                    </div>
                    <!-- Курс скрыт -->
                    <div class="mt-3">
                        <button id="convertPriceBtn" class="btn btn-primary">Рассчитать в рублях</button>
                    </div>
                </div>
                <div id="price-calculation-result" style="display:none;"></div>
            `;
            resultDiv.style.display = 'block';
            // Скрываем кнопку рассчитать цену
            submitBtn.style.display = 'none';
            document.getElementById('convertPriceBtn').addEventListener('click', function() {
                // Получаем элемент для вывода расчётов
                const calcResult = document.getElementById('price-calculation-result');
                const priceCny = parseFloat(document.getElementById('priceCnyInput').value);
                if (isNaN(priceCny) || priceCny <= 0) {
                    alert('Введите корректную цену в юанях');
                    return;
                }
                // Считаем цену в рублях и добавляем процент администратора
                const basePrice = priceCny * data.cny_rate;
                const deliveryOptions = data.delivery_categories;
                // Минимальный процент 5%
                const adminPercent = Math.max(data.admin_percent || 0, 5);
                // Готовим HTML списка доставок и итоговой цены
                const initialDelivery = deliveryOptions[0].cost;
                // Процент от (цена + доставка)
                const adminCharge = Math.round((basePrice + initialDelivery) * adminPercent / 100);
                calcResult.innerHTML = `
                    <div class="category-options-container mt-4">
                        <label class="form-label"><i class="fas fa-shipping-fast me-1"></i>Выберите категорию доставки:</label>
                        <div class="category-options">
                            ${deliveryOptions.map((opt, idx) => `
                                <div class="category-option${idx===0?' active':''}" data-cost="${opt.cost}" data-name="${opt.name}">
                                    <div><strong>${opt.name}</strong> - ${opt.cost} руб.</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="total-price mt-3">
                        <strong>Итого:</strong> <span id="totalPriceValue">${(basePrice + initialDelivery + adminCharge).toLocaleString('ru-RU')} руб.</span>
                    </div>
                    <div class="mt-3">
                        <button id="orderBtn" class="btn btn-success btn-lg"><i class="fas fa-shopping-cart me-2"></i>Оформить заказ</button>
                    </div>
                `;
                calcResult.style.display = 'block';
                // Скрываем только ввод цены и кнопку, оставляем фото и название
                const priceCnyInput = document.getElementById('priceCnyInput');
                if (priceCnyInput && priceCnyInput.parentElement) {
                    priceCnyInput.parentElement.style.display = 'none';
                }
                const convertBtn = document.getElementById('convertPriceBtn');
                if (convertBtn) {
                    convertBtn.style.display = 'none';
                    if (convertBtn.parentElement) {
                        convertBtn.parentElement.style.display = 'none';
                    }
                }
                const img = document.querySelector('.product-info img');
                if (img) {
                    img.style.display = 'block';
                }
                // Обработка выбора категории
                const priceData = {
                    basePrice: basePrice,
                    deliveryCost: deliveryOptions[0].cost,
                    adminPercent: adminPercent,
                    priceCny: priceCny,
                    cnyRate: data.cny_rate,
                    // Расчёт итоговой суммы с учётом процента от (цена + доставка)
                    get totalPrice() {
                        const adminCharge = Math.round((this.basePrice + this.deliveryCost) * this.adminPercent / 100);
                        return Math.round(this.basePrice + this.deliveryCost + adminCharge);
                    }
                };
                document.querySelectorAll('.category-option').forEach(el => el.addEventListener('click', function() {
                    document.querySelectorAll('.category-option').forEach(o => o.classList.remove('active'));
                    this.classList.add('active');
                    priceData.deliveryCost = parseInt(this.dataset.cost);
                    document.getElementById('totalPriceValue').textContent = priceData.totalPrice.toLocaleString('ru-RU') + ' руб.';
                }));
                attachOrderBtnHandler(priceData);
                });
            } else {
                 resultDiv.innerHTML = `
                     <div class="alert alert-danger" role="alert">
                         <i class="fas fa-exclamation-triangle me-2"></i>
                         <strong>Ошибка:</strong> ${data.error}
                     </div>
                 `;
                 resultDiv.style.display = 'block';
             }
    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Ошибка:</strong> Не удалось обработать запрос. Попробуйте позже.
            </div>
        `;
        resultDiv.style.display = 'block';
    } finally {
        loadingDiv.style.display = 'none';
        submitBtn.disabled = false;
    }
});

function attachOrderBtnHandler(priceData) {
    const orderBtn = document.getElementById('orderBtn');
    if (!orderBtn) return;
    const resultDiv = document.getElementById('result');
    orderBtn.addEventListener('mousedown', function(e) { e.preventDefault(); this.blur(); });
    orderBtn.addEventListener('click', function() {
        const telegramModal = new bootstrap.Modal(document.getElementById('telegramModal'));
        telegramModal.show();
        const confirmBtn = document.getElementById('confirmTelegram');
        confirmBtn.onclick = async function() {
            const telegram = document.getElementById('telegramInput').value.trim();
            if (!telegram) {
                document.getElementById('telegramInput').classList.add('is-invalid');
                return;
            }
            orderBtn.disabled = true;
            orderBtn.innerHTML = 'Оформляем заказ...';
            const selectedCategory = document.querySelector('.category-option.active');
            const categoryName = selectedCategory ? selectedCategory.dataset.name : '';
            const productName = document.querySelector('.product-info h4').innerText;
            const imageUrl = document.querySelector('.product-info img').src;
            const orderData = {
                url: document.getElementById('poizonUrl').value.trim(),
                product_name: productName,
                price_cny: priceData.priceCny,
                price_rub: priceData.basePrice,
                total_price: priceData.totalPrice,
                delivery_cost: priceData.deliveryCost,
                category: categoryName,
                image_url: imageUrl,
                telegram: telegram
            };
            const resp = await fetch('/create_order', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(orderData)
            });
            if (resp.ok) {
                resultDiv.innerHTML = `
                    <div class="alert alert-success text-center mt-4" role="alert">
                        <i class="fas fa-check-circle me-2"></i>
                        Заказ успешно оформлен! Мы свяжемся с вами в Telegram.
                    </div>
                `;
                telegramModal.hide();
            } else {
                orderBtn.disabled = false;
                orderBtn.innerHTML = '<i class="fas fa-shopping-cart me-2"></i>Оформить заказ';
                alert('Ошибка при оформлении заказа. Попробуйте позже.');
            }
        };
    });
}
</script>
<style>
/* Стили для карточек выбора категорий */
.category-options {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
}

.category-option {
    flex: 1;
    min-width: 120px;
    padding: 12px;
    border: 2px solid #f0f0f0;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: all 0.2s ease;
}

.category-option:hover {
    border-color: #FFD600;
    background-color: #fffbeb;
}

.category-option.active {
    border-color: #FFD600;
    background-color: #fffbeb;
    box-shadow: 0 3px 10px rgba(255, 214, 0, 0.15);
}

.category-icon {
    font-size: 1.5rem;
    margin-right: 10px;
    color: #333;
}

.category-details {
    flex: 1;
}

.category-name {
    font-weight: bold;
    margin-bottom: 2px;
}

.category-cost {
    font-size: 0.85rem;
    color: #666;
}

.total-price {
    background-color: #fffbeb;
    border-radius: 10px;
    border-left: 4px solid #FFD600;
    font-size: 1.2rem;
    font-weight: 600;
}

.total-price-value {
    font-size: 1.3rem;
    color: #111;
}

@media (max-width: 576px) {
    .category-option {
        min-width: 100%;
    }
}
</style>
{% endblock %}
